def getServers (TOKEN) {
  def CLO_URL="https://api.clo.ru/v1/projects"

  REL=sh (returnStdout:true,
    script: 'curl -X GET -H \"Content-Type: application/json\" -H "Authorization: Bearer ${TOKEN}\"   '+CLO_URL)
  def jsonObj = readJSON text: REL

  def project_id= jsonObj.results[0].id
  println project_id
  CLO_URL= 'https://api.clo.ru/v1/projects/'+project_id+'/servers '
  REL=sh (returnStdout:true,
    script: 'curl -X GET -H \"Content-Type: application/json\" -H "Authorization: Bearer ${TOKEN}\"   '+CLO_URL)
  jsonObj = readJSON text: REL
  println REL
  def str=''
  def mylist=[]
  for(emp in jsonObj.results) {
    mylist.add("${emp.id}_${emp.name}")

	      }


//-H \"Content-Type: application/json\" -H "Authorization: Bearer ${TOKEN}\" \
  // def commits = [:]
      // def CLO_URL="https://api.clo.ru/v1/projects"
      // def response = httpRequest contentType: 'APPLICATION_JSON' ,
      // customHeaders: [ [name: 'Authorization',  value:'Bearer '+TOKEN]] ,url: CLO_URL
    println mylist

    //   def endpoint = CLO_URL + "v1/projects"
    //   def conn = new URL(endpoint).openConnection()
    // //  'Bearer {{ token }}
    //   conn.setRequestProperty("", "Bearer ${AUTH}")
    //   def response = new groovy.json.JsonSlurper().parseText(conn.content.text)
    //   response.values.each {
    //     commits.put(it.displayId, it.message)

    return mylist
}
// def TOKEN     = credentials('clo')
// def SERVERS_LIST = getServers (TOKEN)
//findAMIs().join('\n')
pipeline {
    agent any

    environment {
        TOKEN     = credentials('clo')

    }





      stages() {
        stage('Test1' ) {
        steps {
          script {
            properties([
            parameters([
                                        choice(
                                            choices: getServers( TOKEN ),
                                            name: 'PARAMETER_01'
                                        ),
                                        choice(
                                            choices: ['refresh_servers','delete_server'],
                                            name: 'STEP'
                                        ),
              ])
            ])



      }
      }
      }


        stage('Stage 1') {
            steps {
              script {

              if (STEP=='refresh_servers') {
                println 'refresh server lise'
              } else if    (STEP=='refresh_servers') {
                def server_id =PARAMETER_01.split('_')[0]
                println server_id
              }

          }




        }

    }
  }
    post {
        success {

            archiveArtifacts allowEmptyArchive: true, artifacts: '${WORKSPACE}/simple-back-front/front/*.zip', fingerprint: true

        }
      }
}
